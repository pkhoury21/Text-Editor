import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.GridLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.print.PrinterException;
import java.io.File;
import java.io.FileFilter;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Scanner;
import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JMenu;
import javax.swing.JMenuBar;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JTextArea;
import javax.swing.JTextPane;
import javax.swing.Popup;
import javax.swing.PopupFactory;
import javax.swing.SwingUtilities;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.filechooser.FileNameExtensionFilter;
import javax.swing.text.BadLocationException;
import javax.swing.text.SimpleAttributeSet;
import javax.swing.text.Style;
import javax.swing.text.StyleConstants;
import javax.swing.text.StyleContext;
import javax.swing.text.StyledDocument;
import javax.swing.text.Utilities;

import edu.princeton.cs.algs4.LinkedStack;

public class Text implements ActionListener{
	
	private JFrame frame;
	private JPanel panel;
	private static JTextPane textBox;
	//private static JTextArea textBox;
	JMenuItem exit;

	static SquigglePainter red = new SquigglePainter(Color.RED);
	SpellChecker check = new SpellChecker("dictionary.txt");
	LinkedStack<String> temp = new LinkedStack<String>();
	LinkedStack<String> list = new LinkedStack<String>();
	


    static Collector t = new Collector();
	
	int count = 0;
	
	public Text() {
		frame = new JFrame("Patricks Text Editor");
		panel = new JPanel();
		textBox = new JTextPane();
		//textBox = new JTextArea();
		
		panel.setBorder(BorderFactory.createEmptyBorder(30,30,10,30));//maybe make it to fit whole frame instead
		panel.setLayout(new GridLayout(0,1));
		panel.setBackground(Color.white);
		
		frame.add(panel, BorderLayout.CENTER);
		frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		frame.setSize(350, 350);
		frame.setVisible(true);
		frame.setLocationRelativeTo(null);//centers to screen...
		frame.revalidate();
		
		frame.add(textBox);//adding the text component to the Frame
		
		JMenuBar menubar = new JMenuBar();
		frame.setJMenuBar(menubar);
		
		JMenu file = new JMenu("File");
		menubar.add(file);
		JMenuItem save = new JMenuItem("Save");
		file.add(save);
		save.addActionListener(this);
		JMenuItem open = new JMenuItem("Open File...");
		file.add(open);
		open.addActionListener(this);
		JMenuItem print = new JMenuItem("Print");
		file.add(print);
		print.addActionListener(this);
		exit = new JMenuItem("Exit");
		file.add(exit);
		exit.addActionListener(this);
		
		JMenu edit = new JMenu("Edit");
		menubar.add(edit);
		JMenuItem spellCheck = new JMenuItem("SpellCheck");
		edit.add(spellCheck);
		spellCheck.addActionListener(this);
		JMenuItem copy = new JMenuItem("Copy");
		edit.add(copy);
		copy.addActionListener(this);
		JMenuItem cut = new JMenuItem("Cut");
		edit.add(cut);
		cut.addActionListener(this);
		JMenuItem paste = new JMenuItem("Paste");
		edit.add(paste);
		paste.addActionListener(this);
		JMenuItem all = new JMenuItem("Select All");
		edit.add(all);
		all.addActionListener(this);
				
		JMenu help = new JMenu("Help");
		menubar.add(help);
		JMenuItem about = new JMenuItem("About");
		help.add(about);
		about.addActionListener(this);
		JMenuItem info = new JMenuItem("Task Info");
		help.add(info);
		info.addActionListener(this);
		
		frame.revalidate();
	}
	
	@Override
	public void actionPerformed(ActionEvent e) {
		String option = e.getActionCommand(); 
		JMenuItem choice = (JMenuItem) e.getSource();
		
		//if(option.equals("Exit")) {
		if(choice == exit) {//** can do this way too, might be better...
			System.exit(0);
		}
		else if(option.equals("About")) {
			JOptionPane.showMessageDialog(frame.getComponent(0), "<html>This is a text editor, made by Patrick K<br>Email: patrickkhoury0gmail.com</html>");	
		}
		else if(option.equals("Task Info")) {
			JOptionPane.showMessageDialog(frame.getComponent(0), "<html>Includes SpellChecker<br>To use spellchecking, go to Edit -> Spellchecking<br>Then right click on words to see corrections, or add to dictionary</html>");			
		}
		else if(option.equals("SpellCheck")) {
			final Style defaultStyle = StyleContext.getDefaultStyleContext().getStyle(StyleContext.DEFAULT_STYLE);
			
			final StyledDocument doc = textBox.getStyledDocument();
			doc.addDocumentListener(new DocumentListener() {
				private void clearStyle(final DocumentEvent e) {
					SwingUtilities.invokeLater(() -> doc.setCharacterAttributes(0, doc.getLength(), defaultStyle, true));		
				}
				       
				@Override
				public void insertUpdate(final DocumentEvent e) {
				//When you type a new letter, we want to (lets say) clear all the styles from the whole document...
					clearStyle(e);
				}
				
				@Override
				public void removeUpdate(final DocumentEvent e) {
				    //When you erase a letter, we want to (lets say) clear all styles from the whole document...
				    clearStyle(e);
				}
				
				@Override
				public void changedUpdate(final DocumentEvent e) {
				    //When changing the style of the document, we want to do nothing else (but the change will happen).
				}
			});
			
			final SimpleAttributeSet sas = new SimpleAttributeSet();
			StyleConstants.setUnderline(sas, true);
			StyleConstants.setBackground(sas, Color.red);
			final int start = textBox.getSelectionStart();
			final int end = textBox.getSelectionEnd();
			doc.setCharacterAttributes(start, end - start, sas, true);
			//System.out.println(check.getInfo("word"));
			//^use to get correct spelling
			
			int index = 0;
			String at = "";
			String word = "";
			System.out.println("Doc length is: " + doc.getLength());
			while(index < doc.getLength()) {
				try {
					at = doc.getText(index, 1);
					System.out.println(at);//gets character at that position,
				} catch (BadLocationException e1) {//^^ can use later for once get to space check if its in hashSet if not highlihht red then use other class for options similar to it in hashSet...		
					// TODO Auto-generated catch block
					e1.printStackTrace();
				}
				
				System.out.println("Going through" + index);
				if(isPunctuation(at)) { //add for "quotes" too...
					if(isPunctuation(word)){//another punctuation skip...//Clean this up later and add rest...
						word = "";//^^If previous was punctuation, check by what's saved in word...
						//continue;//work on if I see puncutation
						}
					else {
						System.out.println("My word is: " + word);
						//check the word so far 
						checkWord(check, word, list, temp, index, doc, sas, at);
						//then reset word variable
						word = "";
					}
				}
				else if(index == doc.getLength()-1) {//If at last character in all of writing...
					System.out.println("Or here:" + word + ":");
					if(at.equals("\n")) {//In-case user enters new line as last character("\n")...
						checkWord(check, word, list, temp, index, doc, sas, at);
						//then reset word variable
						word = "";
					}
					else {
						try {
							checkWord(check, word + doc.getText(index, 1), list, temp, index, doc, sas, at);//using to get last character...
						} catch (BadLocationException e1) {
							// TODO Auto-generated catch block
							e1.printStackTrace();
						}
					}
				}
				else if(at.equals("\n")) {//If going to next line//DONE with this condition
					System.out.println("get");
					if(index == doc.getLength()-1) {
						System.out.println("1");
						checkWord(check, word, list, temp, index, doc, sas, at);
					}
					else if(word != "") {//If its a word and not blank
						System.out.println("2");
						checkWord(check, word, list, temp, index, doc, sas, at);
					}
					else {//if it's a empty string...
						System.out.println("----Its blank" + word);
					}
					
					word = "";
				}
				else if(at.equals(" ")) {//DONE with this condition
					System.out.println("My word is:" + word + ":");
					//check the word so far
					if(word.equals("")) {
						System.out.println("Skipped here");
						//skip it
					}
					else {
						System.out.println("HIT");
						checkWord(check, word, list, temp, index, doc, sas, at);
					}
					//then reset word variable
					word = "";
				}
				else {
					word += at;
				}
				index++;
			}
			
			textBox.addMouseListener(new MouseAdapter() {
				private boolean pendingPopUp = false; //Indicates whether we have already a popup popped up...
	                
				private void maybePop(final MouseEvent mevt) {
                    if (mevt.isPopupTrigger()) {
                        if (pendingPopUp)
                            System.err.println("A popup is already popped. Close it to pop a new one.");
                        else
                            pop(mevt);
                    }
                }
                
                @Override
                public void mouseClicked(final MouseEvent mevt) {
                    maybePop(mevt);
                }
                
                @Override
                public void mousePressed(final MouseEvent mevt) {
                    maybePop(mevt);
                }
                
                @Override
                public void mouseReleased(final MouseEvent mevt) {
                    maybePop(mevt);
                }
                
	        	private void pop(final MouseEvent mevt) {
	        		if (SwingUtilities.isRightMouseButton(mevt)) {
	        			try {
	        				final StyledDocument doc = textBox.getStyledDocument();
	                        //Get the location of the document where the user clicked:
	                        final int offset = textBox.viewToModel(mevt.getPoint());
	                         
	                        //Find what word is at the location of the document where the user clicked:
	                        final int start = Utilities.getWordStart(textBox, offset),
	                        end = Utilities.getWordEnd(textBox, offset);
                            
                            //Set the selection to be that word:
                            textBox.setSelectionStart(start);
                            textBox.setSelectionEnd(end);
                            
                            //Obtain the value of the selected word:
                            final String Atword = doc.getText(start, end - start);
                            System.out.println("AYYYYYE");
                            System.out.println(Atword);
                            
                            t.setAt(Atword);//class to save word that we are at...
                            //^remove this line and probbaly the whole t class later when doing clean up code...
                            
                            System.out.println("Hey PRESSED______--------");
                            addWordButton(check, Atword, list, temp);//Here working rn...
                            
                            System.out.println("The clicked word is: " + Atword);//What word was clicked on...

                            //Create the contents of the popup:
                            final JPanel popupPanel = new JPanel();

                            //Create the alternative words (via JButtons):
                            final int cnt = list.size();//4
                            final ArrayList<JButton> words = new ArrayList<>();
                            //for (int i = 0; i < cnt; ++i) {
                            for (String string : list) {
                                final JButton button = new JButton(string);//word + (i + 1)
                                popupPanel.add(button);
                                words.add(button);
                                //System.out.println("Maybe going through: " + string);
                                list.pop();//&-
                            }
                            
                            final JButton addToDictionary = new JButton("Add to Dictionary");
                            popupPanel.add(addToDictionary);
                            
                            final JButton ignore = new JButton("Ignore");
                            popupPanel.add(ignore);
                            
                            final JButton cancel = new JButton("Cancel");
                            popupPanel.add(cancel);

                            //Create the popup itself:
                            final Popup popup = PopupFactory.getSharedInstance().getPopup(textBox, popupPanel, mevt.getXOnScreen(), mevt.getYOnScreen());

                            //Hook action listenere to the word and cancel buttons:
                            words.forEach(button -> button.addActionListener(e -> {
                                try {
                                    //Get the text of that button (it is going to be the new word):
                                    final String newWord = ((JButton) e.getSource()).getText();
                                    
                                    //Replace the old text with the new one:
                                    doc.remove(start, end - start);
                                    doc.insertString(start, newWord, null);
                                    
                                    //Prepare caret position, so the user can keep on writing:
                                    textBox.setCaretPosition(start + newWord.length());
                                }
                                catch (final BadLocationException | RuntimeException x) {
                                    JOptionPane.showMessageDialog(textBox, "Oups!");
                                }
                                finally {
                                    popup.hide();
                                    pendingPopUp = false;
                                }
                            }));
                            
                            cancel.addActionListener(e -> {
                                popup.hide();
                                textBox.setSelectionStart(offset);
                                textBox.setSelectionEnd(offset);
                                pendingPopUp = false;
                            });
                            
                            ignore.addActionListener(e -> {
                            	try {
									doc.remove(start, end - start);
									doc.insertString(start, Atword, null);
								} catch (BadLocationException e1) {
									// TODO Auto-generated catch block
									e1.printStackTrace();
								}
                                popup.hide();
                                textBox.setSelectionStart(offset);
                                textBox.setSelectionEnd(offset);
                                pendingPopUp = false;
                            });
                        
                            addToDictionary.addActionListener(e -> {
                            	System.out.println(Atword);
                            	check.dictionary.put(Atword, Atword);//Adds word to the dictionary...
                            	try {
									doc.remove(start, end - start);
									doc.insertString(start, Atword, null);
								} catch (BadLocationException e1) {
									// TODO Auto-generated catch block
									e1.printStackTrace();
								}
                                popup.hide();
                                textBox.setSelectionStart(offset);
                                textBox.setSelectionEnd(offset);
                                pendingPopUp = false;
                            });
                            
                            pendingPopUp = true;
                            popup.show();
                        }
                        catch (final BadLocationException | RuntimeException x) {
                            JOptionPane.showMessageDialog(textBox, "Oups! No word found?...");
                        }
                    }
                }
                
            });
			check.clearCorrections();//Need this...
			frame.revalidate();
		}
		else if(option.equals("Print")) {
			try {
				textBox.print();
			} catch (PrinterException e1) {
				e1.printStackTrace();
			}
		}
		else if(option.equals("Save")) {//******************Make sure its right
			//String getFileName = JOptionPane.showInputDialog(null, "Enter your directory name with a file name at the end.\nEx: /Users/userName/Desktop/one.txt");	
			JFileChooser fileChooser = new JFileChooser();
			int response = fileChooser.showSaveDialog(null);
			String getFileName = "";
			if(response == JFileChooser.APPROVE_OPTION) {
				getFileName = fileChooser.getSelectedFile().toString();
				//System.out.println("Path is: " + s);
			}
			else {
				System.out.println("Could not find file");
			}
			//--
			FileWriter outputStream = null;
			try {
				outputStream = new FileWriter(new File(getFileName), false);				
			System.out.println("File found");//^/Users/userName/Desktop/one.txt
			
			String getText = textBox.getText();
			outputStream.write(getText);
			outputStream.close();
			}
			catch (IOException e1) {
				e1.printStackTrace();
			}
		}
		else if(option.equals("Open File...")) {
			JFileChooser fileChooser = new JFileChooser();
			FileNameExtensionFilter filter = new FileNameExtensionFilter("Text file", "txt", "text");
			fileChooser.setFileFilter(filter);
			int response = fileChooser.showOpenDialog(null);
			String getFileName = "";
			if(response == JFileChooser.APPROVE_OPTION) {
				getFileName = fileChooser.getSelectedFile().toString();
				//System.out.println("Path is: " + s);
			}
			else {
				System.out.println("Could not find file");
			}
			//--
			//String getFileName = JOptionPane.showInputDialog(null, "Enter your directory name with a file name at the end.\nEx: /Users/userName/Desktop/one.txt");		
			//--
			Scanner inputStream = null;
			try {
				inputStream = new Scanner(new FileInputStream(getFileName));
				System.out.println("File found");
			}
			catch(FileNotFoundException e1) {
				System.out.println("Sorry that file was not found");
			}
			
			String line = "";
			while (inputStream.hasNextLine()) {
				line = line + inputStream.nextLine()  + "\n" ;
				System.out.println(line);//using for debugging
			}
			textBox.setText(line);
			inputStream.close();
			
			
		}
		else if(option.equals("Select All")) {
			textBox.selectAll();
		}
		else if(option.equals("Copy")) {
			textBox.copy();
		}
		else if(option.equals("Cut")) {
			textBox.cut();
		}
		else if(option.equals("Paste")) {
			textBox.paste();
		}
		
	}
	
	public static String getPacket() {
		System.out.println(textBox.getText());
		return textBox.getText();
	}
	
	public static void main(String[] args) {
		Text test = new Text();	
	}
	
	
	public static boolean isPunctuation(String ch) {
    	if(ch.equals(".") || ch.equals(",") || ch.equals("!") || ch.equals("?")
    			|| ch.equals(";") || ch.equals(":") || ch.equals("\"")|| ch.equals("'")) {
    		return true;
    	}
    	else {
    		return false;
    	}
    	
    }
    
    public static void checkWord(SpellChecker check, String word, LinkedStack list, LinkedStack temp, int index, StyledDocument doc, SimpleAttributeSet sas, String at) {
    	if(check.getInfo(word.toLowerCase())) {//Need toLower like this to check incase they are capital...
			System.out.println(word + " Spelled CORRECT!!!!!!!!");//When calling checkInfo above its also adding the words to the Dictionary too...
		}
		else {
			for (Object object : check.possibleWords) {//for testing delete later
				System.out.println("Pt 2: " + object);
			}
			
			System.out.println("Spelled Wrong: " + word + " @ last condition");
			System.out.println("index:" + index + " & word length:" + word.length());
			
			if(!at.equals(" ")) {
				if(!at.equals("\n")) {//If there is a new line make sure to move everything up one spot to fit whole word...
					index+=1;
				}
			}
			try
			{
				//doc.setCharacterAttributes(index-word.length(), index, sas, true);
			    //textBox.getHighlighter().addHighlight(0, 4, red);
				textBox.getHighlighter().addHighlight(index-word.length(), index, red);//had index+1 on 2nd parameter...
				//problem could be that keep moving between textBox and doc maybe make it as one...
			}
			catch(BadLocationException ble) {
				System.out.println(ble.getMessage());
			}
			
			
		}
    }
   
    public static void addWordButton(SpellChecker check, String word,  LinkedStack list, LinkedStack temp) {
    	check.clearCorrections();
		//if(t.getAt().equals(word)) {
		check.getInfo(t.getAt());
			
		System.out.println("The class is " + t.getAt());
		
			temp = check.getCorrections();//gets corrections for words...
			
			for (Object string : temp) {//Worked when made Object then casted to String, had error: "Type mismatch: cannot convert from element type Object to String" 		
				if(check.getInfo((String)string) ) {
					System.out.println("Test to see right words... " + string);
					list.push(string);
					//list.push("patrickz");
				}
				else {
					continue;
				}
				temp.pop();
			}
		//}
    }
    
    
}

